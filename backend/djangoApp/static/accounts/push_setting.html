<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<title>유저 세팅</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
			}
			#logout {
				float: right;
				margin-top: 10px;
			}
			label {
				display: block;
				margin: 10px 0 5px;
			}
			input,
			button {
				padding: 5px;
				font-size: 14px;
			}
			input[type="text"],
			input[type="email"] {
				width: 300px;
			}
			.switch {
				position: relative;
				display: inline-block;
				width: 50px;
				height: 24px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				cursor: pointer;
				inset: 0;
				background: #ccc;
				transition: 0.4s;
				border-radius: 24px;
			}
			.slider:before {
				position: absolute;
				content: "";
				height: 18px;
				width: 18px;
				left: 3px;
				bottom: 3px;
				background: #fff;
				transition: 0.4s;
				border-radius: 50%;
			}
			input:checked + .slider {
				background: #66bb6a;
			}
			input:checked + .slider:before {
				transform: translateX(26px);
			}
			#push-section {
				margin-top: 30px;
				clear: both;
			}
		</style>
	</head>
	<body>
		<button id="logout">로그아웃</button>
		<h2>프로필 정보 수정</h2>
		<form id="profile-form">
			<label>이메일 (수정 불가)</label>
			<input type="email" id="email" disabled />

			<label>이름</label>
			<input type="text" id="name" required />

			<label>닉네임</label>
			<input type="text" id="nickname" required />

			<label>전화번호</label>
			<input type="text" id="phone" required />

			<label>번호판</label>
			<input type="text" id="plate_number" required />

			<button type="submit">저장하기</button>
		</form>

		<div id="push-section">
			<h2>푸시 알림 설정</h2>
			<label>
				<div class="switch">
					<input type="checkbox" id="push_on" />
					<span class="slider"></span>
				</div>
				푸시 받기
			</label>
		</div>

		<script>
			const API = "http://localhost:8000";
			const LOGIN_PAGE = "/static/accounts/signup_login.html";

			// <input> 요소들을 전부 변수에 바인딩
			const logoutBtn = document.getElementById("logout");
			const emailInput = document.getElementById("email");
			const nameInput = document.getElementById("name");
			const nickInput = document.getElementById("nickname");
			const phoneInput = document.getElementById("phone");
			const plateInput = document.getElementById("plate_number");
			const pushToggle = document.getElementById("push_on");

			// 로그아웃 버튼
			console.log("[DEBUG] 스크립트 로드 완료");
			// 로그아웃
			logoutBtn.addEventListener("click", () => {
				console.log("[DEBUG] 로그아웃 클릭");
				localStorage.removeItem("access_token");
				localStorage.removeItem("refresh_token");
				location.href = LOGIN_PAGE;
			});

			// 인증 확인
			const token = localStorage.getItem("access_token");
			console.log("[DEBUG] 엑세스 토큰:", token);
			if (!token) {
				alert("로그인이 필요합니다.");
				console.log("[DEBUG] 인증 없어서 로그인 페이지로 이동");
				location.href = LOGIN_PAGE;
			}
			const HEAD = {
				"Content-Type": "application/json",
				Authorization: "Bearer " + token,
			};

			// VAPID 키 변수
			let vapid_public_key = "";

			// 초기 데이터 로드
			async function loadProfile() {
				console.log("[DEBUG] loadProfile 호출");
				const res = await fetch(`${API}/api/user/profile/`, { headers: HEAD });
				console.log("[DEBUG] loadProfile 응답 상태:", res.status);
				if (!res.ok) {
					console.error("[ERROR] 프로필 불러오기 실패");
					alert("프로필을 불러올 수 없습니다.");
					return (location.href = LOGIN_PAGE);
				}
				const j = await res.json();
				console.log("[DEBUG] 프로필 데이터:", j);

				emailInput.value = j.email;
				nameInput.value = j.name;
				nickInput.value = j.nickname;
				phoneInput.value = j.phone;
				plateInput.value = j.plate_number;
				pushToggle.checked = j.push_on;
				vapidPublicKey = j.vapid_public_key;

				console.log("[DEBUG] VAPID Public Key:", vapid_public_key);
			}
			loadProfile();

			// 프로필 저장
			document.getElementById("profile-form").addEventListener("submit", async (e) => {
				e.preventDefault();
				console.log("[DEBUG] 프로필 저장 submit 이벤트");
				const body = {
					name: nameInput.value,
					nickname: nickInput.value,
					phone: phoneInput.value,
					plate_number: plateInput.value,
				};
				console.log("[DEBUG] 저장할 프로필 데이터:", body);
				const res = await fetch(`${API}/api/user/profile/`, {
					method: "PUT",
					headers: HEAD,
					body: JSON.stringify(body),
				});
				console.log("[DEBUG] 프로필 저장 응답 상태:", res.status);
				if (res.ok) {
					alert("프로필이 저장되었습니다.");
					console.log("[DEBUG] 프로필 저장 성공");
				} else {
					console.error("[ERROR] 프로필 저장 실패");
					alert("프로필 저장 실패");
				}
			});

			// 푸시 토글 처리
			document.getElementById("push_on").addEventListener("change", async (e) => {
				const on = e.target.checked;
				console.log("[DEBUG] push_on 토글:", on);

				// 서비스워커 등록
				let reg = null;
				try {
					reg = await navigator.serviceWorker.register("/static/accounts/service-worker.js");
					console.log("[DEBUG] SW 등록 성공:", reg);
				} catch (err) {
					console.warn("[DEBUG] SW 등록 실패:", err);
				}

				if (on && reg) {
					console.log("[DEBUG] 푸시 구독 시작");
					const sub = await reg.pushManager.subscribe({
						userVisibleOnly: true,
						applicationServerKey: urlBase64ToUint8Array(vapid_public_key),
					});
					console.log("[DEBUG] 구독 객체:", sub);
					await fetch(`${API}/api/push/subscribe/`, {
						method: "POST",
						headers: HEAD,
						body: JSON.stringify(sub.toJSON()),
					});
					console.log("[DEBUG] /api/push/subscribe/ 완료");
				} else if (!on && reg) {
					console.log("[DEBUG] 푸시 해제 시작");
					const sub = await reg.pushManager.getSubscription();
					console.log("[DEBUG] 기존 구독 객체:", sub);
					if (sub) {
						await sub.unsubscribe();
						console.log("[DEBUG] SW 구독 해제 완료");
						await fetch(`${API}/api/push/unsubscribe/`, {
							method: "POST",
							headers: HEAD,
							body: JSON.stringify({ endpoint: sub.endpoint }),
						});
						console.log("[DEBUG] /`api/push/unsubscribe/ 완료");
					}
				}

				// 서버에도 설정 저장
				console.log("[DEBUG] 푸시 설정 서버 저장:", on);
				const settingRes = await fetch(`${API}/api/push/setting/`, {
					method: "POST",
					headers: HEAD,
					body: JSON.stringify({ push_on: on }),
				});
				console.log("[DEBUG] /api/push/setting/ 응답 상태:", settingRes.status);
				alert(`푸시 알림이 ${on ? "활성화" : "비활성화"} 되었습니다.`);
			});

			// base64 → Uint8Array
			function urlBase64ToUint8Array(b64) {
				const pad = "=".repeat((4 - (b64.length % 4)) % 4);
				const bin = atob(b64.replace(/-/g, "+").replace(/_/g, "/") + pad);
				return Uint8Array.from(bin, (c) => c.charCodeAt(0));
			}
		</script>
	</body>
</html>
