<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<title>유저 세팅</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
			}
			#logout {
				float: right;
				margin-top: 10px;
			}
			label {
				display: block;
				margin: 10px 0 5px;
			}
			input,
			button {
				padding: 5px;
				font-size: 14px;
			}
			input[type="text"],
			input[type="email"] {
				width: 300px;
			}
			.switch {
				position: relative;
				display: inline-block;
				width: 50px;
				height: 24px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				inset: 0;
				background: #ccc;
				transition: 0.4s;
				border-radius: 24px;
			}
			.slider:before {
				content: "";
				position: absolute;
				height: 18px;
				width: 18px;
				left: 3px;
				bottom: 3px;
				background: #fff;
				transition: 0.4s;
				border-radius: 50%;
			}
			input:checked + .slider {
				background: #66bb6a;
			}
			input:checked + .slider:before {
				transform: translateX(26px);
			}
			#push-section {
				margin-top: 30px;
				clear: both;
			}
		</style>
	</head>
	<body>
		<button id="logout">로그아웃</button>
		<h2>프로필 정보 수정</h2>
		<form id="profile-form">
			<label>이메일 (수정 불가)</label>
			<input type="email" id="email" disabled />

			<label>이름</label>
			<input type="text" id="name" required />

			<label>닉네임</label>
			<input type="text" id="nickname" required />

			<label>전화번호</label>
			<input type="text" id="phone" required />

			<button type="submit">저장하기</button>
		</form>

		<div id="push-section">
			<h2>푸시 알림 설정</h2>
			<label>
				<div class="switch">
					<input type="checkbox" id="push_on" />
					<span class="slider"></span>
				</div>
				푸시 받기
			</label>
		</div>
		<!-- 차량 추가 페이지로 이동하는 링크 -->
		<div style="margin-top: 20px">
			<a href="add_vehicle.html" style="text-decoration: none; font-weight: bold; color: #1976d2"> ➤ 내 차를 추가해주세요 </a>
		</div>
		<!-- ① 내 차 목록을 표시할 영역 -->
		<div id="vehicle-list"></div>

		<script>
			const API = "http://localhost:8000";
			const LOGIN_PAGE = "/static/accounts/signup_login.html";

			// element refs
			const logoutBtn = document.getElementById("logout");
			const emailInput = document.getElementById("email");
			const nameInput = document.getElementById("name");
			const nickInput = document.getElementById("nickname");
			const phoneInput = document.getElementById("phone");
			const pushToggle = document.getElementById("push_on");

			// 로그아웃
			logoutBtn.addEventListener("click", () => {
				localStorage.removeItem("access_token");
				localStorage.removeItem("refresh_token");
				location.href = LOGIN_PAGE;
			});

			// 인증 체크
			const token = localStorage.getItem("access_token");
			if (!token) {
				alert("로그인이 필요합니다.");
				location.href = LOGIN_PAGE;
			}
			const HEAD = {
				"Content-Type": "application/json",
				Authorization: "Bearer " + token,
			};

			let vapid_public_key = "";

			// 프로필 불러오기
			async function loadProfile() {
				const res = await fetch(`${API}/api/users/me/`, { headers: HEAD });
				if (!res.ok) {
					alert("프로필을 불러올 수 없습니다.");
					return (location.href = LOGIN_PAGE);
				}
				const j = await res.json();
				emailInput.value = j.email;
				nameInput.value = j.name; // serializer.source="full_name"
				nickInput.value = j.nickname;
				phoneInput.value = j.phone;
				pushToggle.checked = j.push_on;
				vapid_public_key = j.vapid_public_key;
			}
			loadProfile();

			// 프로필 저장
			document.getElementById("profile-form").addEventListener("submit", async (e) => {
				e.preventDefault();
				const body = {
					name: nameInput.value,
					nickname: nickInput.value,
					phone: phoneInput.value,
				};
				const res = await fetch(`${API}/api/users/me/`, {
					method: "PUT",
					headers: HEAD,
					body: JSON.stringify(body),
				});
				if (res.ok) {
					alert("프로필이 저장되었습니다.");
				} else {
					alert("프로필 저장에 실패했습니다.");
				}
			});

			// 푸시 토글
			pushToggle.addEventListener("change", async (e) => {
				const on = e.target.checked;
				// 서비스워커 등록
				let reg = null;
				try {
					reg = await navigator.serviceWorker.register("/static/accounts/service-worker.js");
				} catch {}
				if (reg) {
					if (on) {
						const sub = await reg.pushManager.subscribe({
							userVisibleOnly: true,
							applicationServerKey: urlBase64ToUint8Array(vapid_public_key),
						});
						await fetch(`${API}/api/push/subscribe/`, {
							method: "POST",
							headers: HEAD,
							body: JSON.stringify(sub.toJSON()),
						});
					} else {
						const sub = await reg.pushManager.getSubscription();
						if (sub) {
							await sub.unsubscribe();
							await fetch(`${API}/api/push/unsubscribe/`, {
								method: "POST",
								headers: HEAD,
								body: JSON.stringify({ endpoint: sub.endpoint }),
							});
						}
					}
				}
				// 서버 설정 저장
				await fetch(`${API}/api/push/setting/`, {
					method: "POST",
					headers: HEAD,
					body: JSON.stringify({ push_on: on }),
				});
				alert(`푸시 알림이 ${on ? "활성화" : "비활성화"} 되었습니다.`);
			});

			// VAPID 키 디코드 헬퍼
			function urlBase64ToUint8Array(b64) {
				const pad = "=".repeat((4 - (b64.length % 4)) % 4);
				const bin = atob(b64.replace(/-/g, "+").replace(/_/g, "/") + pad);
				return Uint8Array.from(bin, (c) => c.charCodeAt(0));
			}
			// ② 차량 목록 불러와서 렌더링
			async function loadVehicles() {
				const res = await fetch(`${API}/api/vehicles/`, { headers: HEAD });
				if (!res.ok) {
					console.error("차량 목록 로드 실패");
					return;
				}
				const vehicles = await res.json();
				const container = document.getElementById("vehicle-list");
				container.innerHTML = ""; // 초기화

				vehicles.forEach((v) => {
					const card = document.createElement("div");
					card.className = "vehicle-card";
					card.innerHTML = `
          <div class="vehicle-info">
            <div><strong>번호판:</strong> ${v.license_plate}</div>
            <div><strong>모델:</strong> ${v.model.brand} ${v.model.model_name}</div>
          </div>
          <img src="${v.model.image_url}" alt="차량 이미지" />
          <div class="vehicle-actions">
            <button onclick="editVehicle(${v.id})">수정</button>
            <button onclick="deleteVehicle(${v.id})">삭제</button>
          </div>
        `;
					container.appendChild(card);
				});
			}
			// 페이지 로드 시 차량 목록도 불러오기
			loadVehicles();

			// 차량 삭제
			async function deleteVehicle(id) {
				if (!confirm("정말 삭제하시겠습니까?")) return;
				const res = await fetch(`${API}/api/vehicles/${id}/`, {
					method: "DELETE",
					headers: HEAD,
				});
				if (res.ok) {
					alert("삭제되었습니다.");
					loadVehicles();
				} else {
					alert("삭제에 실패했습니다.");
				}
			}

			// 차량 수정(추가 구현 필요)
			function editVehicle(id) {
				// 예: 수정 페이지로 이동
				location.href = `edit_vehicle.html?id=${id}`;
			}
		</script>
	</body>
</html>
