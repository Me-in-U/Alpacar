<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<title>JWT 테스트 페이지</title>
		<style>
			body {
				margin: 0;
				font-family: Arial, sans-serif;
			}
			.pane {
				width: 100%;
				padding: 20px;
				box-sizing: border-box;
			}
			h2 {
				margin: 10px 0;
			}
			button {
				margin: 5px 0;
			}
			input {
				display: block;
				margin: 5px 0;
				padding: 8px;
				width: 100%;
				box-sizing: border-box;
			}
		</style>
	</head>
	<body>
		<div class="pane">
			<h2>회원가입(Signup + JWT)</h2>
			<button onclick="fillSignup()">랜덤 채우기</button>
			<form id="signup-form">
				<input id="su_name" placeholder="이름 (full_name)" />
				<!-- 이메일 + 중복체크 -->
				<div class="inline">
					<input id="su_email" placeholder="이메일" />
					<button type="button" id="btn_check_email">이메일 중복체크</button>
					<span id="ok_email" class="checkmark">✔</span>
				</div>
				<input id="su_pass" type="password" placeholder="비밀번호" />
				<input id="su_pass2" type="password" placeholder="비밀번호 확인" />
				<input id="su_phone" placeholder="전화번호" />
				<!-- 닉네임 + 중복체크 -->
				<div class="inline">
					<input id="su_nickname" placeholder="닉네임" />
					<button type="button" id="btn_check_nick">닉네임 중복체크</button>
					<span id="ok_nick" class="checkmark">✔</span>
				</div>
				<button type="submit" id="btn_signup" disabled>가입</button>
			</form>

			<h2>로그인(Login + JWT)</h2>
			<button onclick="fillLogin()">랜덤 채우기</button>
			<form onsubmit="onLogin(event)">
				<!-- id를 li_email / li_pass 로 통일 -->
				<input id="li_email" placeholder="Email" />
				<input id="li_pass" type="password" placeholder="Password" />
				<button type="submit">로그인</button>
			</form>
			<!-- 소셜 로그인 테스트 섹션 추가 -->
			<h2>소셜 로그인 테스트</h2>
			<!-- Google 로그인 -->
			<button id="btn_google_login">Google로 로그인</button>
			<!-- Kakao 로그인 -->
			<button id="btn_kakao_login">Kakao로 로그인</button>
		</div>
	</body>
	<script>
		// const HOST = window.location.hostname; // 예: "192.168.45.183"
		// const PORT = "8000";
		// const API = `http://${HOST}:${PORT}`;

		// 배포 혹은 ngrok 사용 시
		const API = window.location.origin;

		// 상태 변수
		let emailChecked = false;
		let nickChecked = false;

		// 엘리먼트 참조
		const suNameInput = document.getElementById("su_name");
		const suEmailInput = document.getElementById("su_email");
		const suPassInput = document.getElementById("su_pass");
		const suPass2Input = document.getElementById("su_pass2");
		const suPhoneInput = document.getElementById("su_phone");
		const suNickInput = document.getElementById("su_nickname");

		const btnCheckEmail = document.getElementById("btn_check_email");
		const okEmailMark = document.getElementById("ok_email");

		const btnCheckNick = document.getElementById("btn_check_nick");
		const okNickMark = document.getElementById("ok_nick");

		const btnSignup = document.getElementById("btn_signup");
		const formSignup = document.getElementById("signup-form");

		// 버튼 활성화 갱신
		function updateSignupEnabled() {
			btnSignup.disabled = !(emailChecked && nickChecked);
		}

		// 랜덤 값 생성
		function rand(len) {
			return Math.random().toString(36).substr(2, len);
		}

		// 페이지 로드 시 초기화
		document.addEventListener("DOMContentLoaded", () => {
			// 1. 체크 상태 초기화
			emailChecked = false;
			nickChecked = false;

			// 2. 체크마크 숨기기
			okEmailMark.style.display = "none";
			okNickMark.style.display = "none";

			// 3. 가입 버튼 비활성화
			updateSignupEnabled();
		});

		// 랜덤 채우기
		function fillSignup() {
			document.getElementById("su_name").value = rand(6);
			document.getElementById("su_nickname").value = rand(6);
			document.getElementById("su_email").value = rand(5) + "@test.com";
			document.getElementById("su_pass").value = rand(8);
			document.getElementById("su_phone").value = "010" + ("" + Math.floor(Math.random() * 1e8)).padStart(8, "0");
			document.getElementById("su_plate").value = "12가" + ("" + Math.floor(Math.random() * 1e4)).padStart(4, "0");
			// 입력 변경시 체크 리셋
			resetEmailCheck();
			resetNickCheck();
		}

		// 이메일 중복체크
		btnCheckEmail.addEventListener("click", async () => {
			const email = suEmailInput.value.trim();
			if (!email) {
				alert("이메일을 입력해주세요.");
				return;
			}
			// 간단 이메일 형식 체크 (optional)
			if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
				alert("유효한 이메일을 입력해주세요.");
				return;
			}

			try {
				const res = await fetch(`${API}/api/auth/check-email/?email=${encodeURIComponent(email)}`);
				if (!res.ok) throw new Error();
				const { exists } = await res.json();
				if (exists) {
					alert("이미 사용 중인 이메일입니다.");
					emailChecked = false;
					okEmailMark.style.display = "none";
				} else {
					alert("사용 가능한 이메일입니다!");
					emailChecked = true;
					okEmailMark.style.display = "inline";
				}
			} catch {
				alert("이메일 중복체크 API 호출 실패");
				emailChecked = false;
				okEmailMark.style.display = "none";
			}
			updateSignupEnabled();
		});

		// 닉네임 중복체크
		btnCheckNick.addEventListener("click", async () => {
			const nickname = suNickInput.value.trim();
			if (!nickname) {
				alert("닉네임을 입력해주세요.");
				return;
			}
			if (nickname.length < 3 || nickname.length > 6) {
				alert("닉네임은 3글자 이상, 6글자 이하로 입력해주세요.");
				return;
			}

			try {
				const res = await fetch(`${API}/api/auth/check-nickname/?nickname=${encodeURIComponent(nickname)}`);
				if (!res.ok) throw new Error();
				const { exists } = await res.json();
				if (exists) {
					alert("이미 사용 중인 닉네임입니다.");
					nickChecked = false;
					okNickMark.style.display = "none";
				} else {
					alert("사용 가능한 닉네임입니다!");
					nickChecked = true;
					okNickMark.style.display = "inline";
				}
			} catch {
				alert("닉네임 중복체크 API 호출 실패");
				nickChecked = false;
				okNickMark.style.display = "none";
			}
			updateSignupEnabled();
		});

		// 입력 변경 시 이메일 체크 리셋
		suEmailInput.addEventListener("input", () => {
			resetEmailCheck();
			updateSignupEnabled();
		});
		function resetEmailCheck() {
			emailChecked = false;
			okEmailMark.style.display = "none";
		}

		// 입력 변경 시 닉네임 체크 리셋
		suNickInput.addEventListener("input", () => {
			resetNickCheck();
			updateSignupEnabled();
		});
		function resetNickCheck() {
			nickChecked = false;
			okNickMark.style.display = "none";
		}

		// 회원가입 폼 제출
		formSignup.addEventListener("submit", async (e) => {
			e.preventDefault();
			if (!emailChecked || !nickChecked) {
				alert("이메일과 닉네임 중복체크를 모두 완료해주세요.");
				return;
			}
			const data = {
				full_name: suNameInput.value.trim(),
				email: suEmailInput.value.trim(),
				password: suPassInput.value,
				password2: suPass2Input.value,
				phone: suPhoneInput.value.trim(),
				nickname: suNickInput.value.trim(),
			};
			try {
				const res = await fetch(`${API}/api/auth/signup/`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(data),
				});
				const json = await res.json();
				if (res.ok) {
					alert("회원가입 성공! 이제 로그인해주세요.");
				} else {
					alert("실패: " + JSON.stringify(json));
				}
			} catch {
				alert("회원가입 요청 중 오류가 발생했습니다.");
			}
		});

		function fillLogin() {
			document.getElementById("li_email").value = rand(5) + "@test.com";
			document.getElementById("li_pass").value = rand(8);
		}

		async function onLogin(e) {
			e.preventDefault();
			const email = document.getElementById("li_email").value;
			const password = document.getElementById("li_pass").value;

			const result = await fetch(`${API}/api/auth/login/`, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ email, password }),
			});
			const json = await result.json();

			if (result.ok) {
				localStorage.setItem("access_token", json.access);
				localStorage.setItem("refresh_token", json.refresh);
				// SPA 라우터 대신 단순 이동
				window.location.href = "/static/accounts/push_setting.html";
			} else {
				alert("실패: " + JSON.stringify(json));
			}
		}
		document.getElementById("btn_google_login").addEventListener("click", () => {
			window.location.href = `${API}/api/auth/social/google/login/`;
		});

		document.getElementById("btn_kakao_login").addEventListener("click", async () => {
			const res = await fetch(`${API}/api/auth/social/kakao/login_url/`);
			const { url } = await res.json();
			window.location.href = url;
		});
	</script>
</html>
