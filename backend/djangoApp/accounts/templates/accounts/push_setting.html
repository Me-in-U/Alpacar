{% comment %} accounts/push_setting.html {% endcomment %} {% load static %}
<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<title>푸시 알림 설정</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
			}
			.switch {
				position: relative;
				display: inline-block;
				width: 60px;
				height: 34px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				transition: 0.4s;
				border-radius: 34px;
			}
			.slider:before {
				position: absolute;
				content: "";
				height: 26px;
				width: 26px;
				left: 4px;
				bottom: 4px;
				background-color: white;
				transition: 0.4s;
				border-radius: 50%;
			}
			input:checked + .slider {
				background-color: #66bb6a;
			}
			input:checked + .slider:before {
				transform: translateX(26px);
			}
			label {
				display: flex;
				align-items: center;
				gap: 12px;
			}
		</style>
	</head>
	<body>
		<h2>푸시 알림 설정</h2>
		<label>
			OCR 결과 푸시 알림 받기
			<div class="switch">
				<input type="checkbox" id="push_on" {% if push_on %}checked{% endif %} />
				<span class="slider"></span>
			</div>
		</label>

		<script>
			const API_BASE = "http://localhost:8000";
			const TOKEN = localStorage.getItem("access_token");
			const headers = {
				"Content-Type": "application/json",
				Authorization: "Bearer " + TOKEN,
			};

			// 1) 현재 설정 불러오기
			async function loadSetting() {
				const res = await fetch(`${API_BASE}/api/push/setting/`, {
					method: "GET",
					headers,
				});
				const data = await res.json();
				document.getElementById("push_on").checked = data.push_on;
			}

			// 2) 서비스워커 준비
			function urlBase64ToUint8Array(base64String) {
				const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
				const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
				const raw = atob(base64);
				return Uint8Array.from(raw, (c) => c.charCodeAt(0));
			}

			async function readySW() {
				const reg = await navigator.serviceWorker.register("/static/service-worker.js");
				return reg;
			}

			// 3) 구독 등록/해제 & 서버 동기화
			document.getElementById("push_on").addEventListener("change", async (e) => {
				const on = e.target.checked;
				const reg = await readySW();
				const pm = reg.pushManager;
				let sub = await pm.getSubscription();

				if (on) {
					if (!sub) {
						sub = await pm.subscribe({
							userVisibleOnly: true,
							applicationServerKey: urlBase64ToUint8Array("{{ VAPID_PUBLIC_KEY }}"),
						});
					}
					// 서버에 구독 등록
					await fetch(`${API_BASE}/push/subscribe/`, {
						method: "POST",
						headers,
						body: JSON.stringify(sub.toJSON()),
					});
				} else {
					if (sub) {
						await sub.unsubscribe();
						// 서버에 구독 해제 알림
						await fetch(`${API_BASE}/push/unsubscribe/`, {
							method: "POST",
							headers,
							body: JSON.stringify({ endpoint: sub.endpoint }),
						});
					}
				}

				// 4) 설정 상태 업데이트
				await fetch(`${API_BASE}/push/setting/update/`, {
					method: "POST",
					headers,
					body: JSON.stringify({ push_on: on }),
				});

				alert(`푸시 알림이 ${on ? "ON" : "OFF"} 처리되었습니다.`);
			});

			// 페이지 로드 시 초기화
			loadSetting().catch(console.error);
		</script>
	</body>
</html>
