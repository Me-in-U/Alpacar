{% load static %}
<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<title>푸시 알림 설정</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
			}
			.switch {
				position: relative;
				display: inline-block;
				width: 60px;
				height: 34px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: #ccc;
				transition: 0.4s;
				border-radius: 34px;
			}
			.slider:before {
				position: absolute;
				content: "";
				height: 26px;
				width: 26px;
				left: 4px;
				bottom: 4px;
				background: white;
				transition: 0.4s;
				border-radius: 50%;
			}
			input:checked + .slider {
				background: #66bb6a;
			}
			input:checked + .slider:before {
				transform: translateX(26px);
			}
			label {
				display: flex;
				align-items: center;
				gap: 12px;
			}
		</style>
	</head>
	<body>
		<h2>OCR 푸시 알림 설정</h2>
		<label>
			푸시 받기
			<div class="switch">
				<input type="checkbox" id="push_on" />
				<span class="slider"></span>
			</div>
		</label>

		<script>
			const API = "http://localhost:8000";
			const TOK = localStorage.getItem("access_token");
			const HEADS = { "Content-Type": "application/json", Authorization: "Bearer " + TOK };
			const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY }}";

			// 초기 설정 로드
			async function loadSetting() {
				const res = await fetch(`${API}/api/push/setting/`, { method: "GET", headers: HEADS });
				const j = await res.json();
				push_on.checked = j.push_on;
			}

			function urlBase64ToUint8Array(b64) {
				const pad = "=".repeat((4 - (b64.length % 4)) % 4);
				const str = (b64 + pad).replace(/-/g, "+").replace(/_/g, "/");
				const bin = atob(str);
				return Uint8Array.from(bin, (c) => c.charCodeAt(0));
			}

			async function readySW() {
				return navigator.serviceWorker.register("/static/service-worker.js");
			}

			push_on.addEventListener("change", async (e) => {
				const on = e.target.checked;
				const reg = await readySW();
				const pm = reg.pushManager;
				let sub = await pm.getSubscription();

				if (on) {
					if (!sub) {
						sub = await pm.subscribe({
							userVisibleOnly: true,
							applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
						});
					}
					// 구독 정보 서버 전송
					await fetch(`${API}/api/push/subscribe/`, {
						method: "POST",
						headers: HEADS,
						body: JSON.stringify(sub.toJSON()),
					});
				} else {
					if (sub) {
						await sub.unsubscribe();
						await fetch(`${API}/api/push/unsubscribe/`, {
							method: "POST",
							headers: HEADS,
							body: JSON.stringify({ endpoint: sub.endpoint }),
						});
					}
				}

				// 설정 상태 저장
				await fetch(`${API}/api/push/setting/`, {
					method: "POST",
					headers: HEADS,
					body: JSON.stringify({ push_on: on }),
				});

				alert(`푸시 알림이 ${on ? "ON" : "OFF"} 처리되었습니다.`);
			});

			loadSetting().catch(console.error);
		</script>
	</body>
</html>
