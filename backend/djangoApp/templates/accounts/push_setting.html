{% load static %}
<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<title>푸시 알림 설정</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
			}
			.switch {
				position: relative;
				display: inline-block;
				width: 60px;
				height: 34px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				transition: 0.4s;
				border-radius: 34px;
			}
			.slider:before {
				position: absolute;
				content: "";
				height: 26px;
				width: 26px;
				left: 4px;
				bottom: 4px;
				background-color: white;
				transition: 0.4s;
				border-radius: 50%;
			}
			input:checked + .slider {
				background-color: #66bb6a;
			}
			input:checked + .slider:before {
				transform: translateX(26px);
			}
			label {
				display: flex;
				align-items: center;
				gap: 12px;
			}
		</style>
	</head>
	<body>
		<h2>푸시 알림 설정</h2>
		<label>
			OCR 결과 푸시 알림 받기
			<div class="switch">
				<input type="checkbox" id="push_on" {% if push_on %}checked{% endif %} />
				<span class="slider"></span>
			</div>
		</label>

		<script>
			const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY }}";

			// Base64URL → Uint8Array
			function urlBase64ToUint8Array(base64String) {
				const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
				const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
				const rawData = atob(base64);
				return Uint8Array.from(rawData, (c) => c.charCodeAt(0));
			}

			// 서비스워커 준비
			async function readySW() {
				if (!("serviceWorker" in navigator)) throw "No SW";
				return navigator.serviceWorker.register("/static/service-worker.js").then((reg) => reg);
			}

			// 서버에 구독 정보 전송
			async function sendSubscription(sub, url) {
				await fetch(url, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"X-CSRFToken": "{{ csrf_token }}",
					},
					body: JSON.stringify(sub),
				});
			}

			document.getElementById("push_on").addEventListener("change", async (e) => {
				const checked = e.target.checked;
				const reg = await readySW();
				const pm = reg.pushManager;
				let sub = await pm.getSubscription();

				if (checked) {
					// --- 구독 등록 ---
					if (!sub) {
						sub = await pm.subscribe({
							userVisibleOnly: true,
							applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
						});
					}
					// DB에 저장
					await sendSubscription(sub.toJSON(), "{% url 'push-subscribe' %}");
				} else {
					// --- 구독 해제 ---
					if (sub) {
						await sub.unsubscribe();
						// 서버에도 알려서 레코드 삭제
						await sendSubscription({ endpoint: sub.endpoint }, "{% url 'push-unsubscribe' %}");
					}
				}

				// 알림 on/off 설정도 함께 저장
				await fetch("{% url 'push-setting-update' %}", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"X-CSRFToken": "{{ csrf_token }}",
					},
					body: JSON.stringify({ push_on: checked }),
				});
				alert(`푸시 알림이 ${checked ? "ON" : "OFF"} 처리되었습니다.`);
			});
		</script>
	</body>
</html>
